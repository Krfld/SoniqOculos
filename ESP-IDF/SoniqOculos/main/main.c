#include "main.h"

#include "bt.h"
#include "i2s.h"
#include "gpio.h"
#include "sd.h"

static fir_f32_t *fir;
const int N = 128;
static float delays[128];
static float coeffs[128] = { // LPF 1kHz
    0.0001475542154998, 0.0002034934204362, 0.0002613500229258, 0.0003219593557609,
    0.0003857489780943, 0.0004526126803711, 0.0005218052976215, 0.0005918647845958,
    0.0006605671716692, 0.0007249189358762, 0.0007811900193194, 0.0008249892485852,
    0.0008513823021262, 0.0008550506920711, 0.0008304885309122, 0.0007722322024105,
    0.0006751165103611, 0.0005345494970521, 0.0003467969597483, 0.0001092667967279,
    -0.0001792172751424, -0.0005181633403933, -0.000905190843687, -0.001335852212612,
    -0.001803505829214, -0.002299248445037, -0.002811913622871, -0.003328140994181,
    -0.003832519093682, -0.004307802330198, -0.004735200341405, -0.005094735630258,
    -0.005365663066885, -0.005526942636179, -0.00555775479139, -0.005438046006617,
    -0.005149090668993, -0.004674054368621, -0.003998542974814, -0.003111121662689,
    -0.002003788293374, -0.0006723862586205, 0.0008830569333099, 0.002658077452989,
    0.004643619451663, 0.006825983651721, 0.009186885380958, 0.01170362436703,
    0.01434936563712, 0.01709352784886, 0.01990227239911, 0.02273908380479,
    0.02556542920988, 0.02834148252377, 0.0310268967109, 0.03358160619194,
    0.03596664023192, 0.03814492761831, 0.04008207289229, 0.04174708489653,
    0.04311303943241, 0.04415765935371, 0.04486379742158, 0.04521980965392,
    0.04521980965392, 0.04486379742158, 0.04415765935371, 0.04311303943241,
    0.04174708489653, 0.04008207289229, 0.03814492761831, 0.03596664023192,
    0.03358160619194, 0.0310268967109, 0.02834148252377, 0.02556542920988,
    0.02273908380479, 0.01990227239911, 0.01709352784886, 0.01434936563712,
    0.01170362436703, 0.009186885380958, 0.006825983651721, 0.004643619451663,
    0.002658077452989, 0.0008830569333099, -0.0006723862586205, -0.002003788293374,
    -0.003111121662689, -0.003998542974814, -0.004674054368621, -0.005149090668993,
    -0.005438046006617, -0.00555775479139, -0.005526942636179, -0.005365663066885,
    -0.005094735630258, -0.004735200341405, -0.004307802330198, -0.003832519093682,
    -0.003328140994181, -0.002811913622871, -0.002299248445037, -0.001803505829214,
    -0.001335852212612, -0.000905190843687, -0.0005181633403933, -0.0001792172751424,
    0.0001092667967279, 0.0003467969597483, 0.0005345494970521, 0.0006751165103611,
    0.0007722322024105, 0.0008304885309122, 0.0008550506920711, 0.0008513823021262,
    0.0008249892485852, 0.0007811900193194, 0.0007249189358762, 0.0006605671716692,
    0.0005918647845958, 0.0005218052976215, 0.0004526126803711, 0.0003857489780943,
    0.0003219593557609, 0.0002613500229258, 0.0002034934204362, 0.0001475542154998};

void delay(int millis)
{
    vTaskDelay(millis / portTICK_PERIOD_MS);
}

void app_main(void)
{
    bt_init();
    spi_init();
    sd_det_task_init();
    gpio_task_init();

    speakers_init();
    bone_conductors_init();
    bt_music_init();

    // Proccessing
    //dsps_fir_init_f32(fir, coeffs, delays, N);

    printf("\nSetup ready\n\n");
}

void handleMsgs(char *msg)
{
    //TODO Implement with flutter

    printf("\n%s\n\n", msg);

    // Response
    sprintf(msg, "Message received\n");
}

//static int buffer_index = 0;
//static int16_t buffer[1024];

void process_data(uint8_t *data, size_t *len)
{
    int16_t *samples = (int16_t *)data; // [0] - Left | [1] - Right | [2] - Left | [3] - Right ...

    /*int16_t *samples_left = {0};
    int16_t *samples_right = {0};

    int sample_amount = *len / 4;
    for (size_t i = 0; i < sample_amount; i++)
    {
        samples_left[i] = (int16_t)(data[i * 4 + 1] << 8 | data[i * 4 + 0]);
        samples_right[i] = (int16_t)(data[i * 4 + 3] << 8 | data[i * 4 + 2]);
    }*/

    //dsps_fir_f32_ae32(fir,);

    //TODO Process data
    i2s_write_data(data, len);

    //sd_write_data(data, len); //! Testing
}
